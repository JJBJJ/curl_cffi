name: Build curl-cffi for Android

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ› ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ“¥ å…‹éš† Chaquopy
      run: |
        git clone --depth 1 https://github.com/chaquo/chaquopy.git
        echo "CHAQUOPY_DIR=$PWD/chaquopy" >> $GITHUB_ENV

    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿå·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y patch patchelf wget unzip pkg-config libssl-dev

    - name: â¬‡ï¸ ä¸‹è½½ Python ç›®æ ‡æ–‡ä»¶
      run: |
        echo "ä¸‹è½½ Python 3.8.20-1 ç›®æ ‡æ–‡ä»¶..."
        mkdir -p chaquopy/maven/com/chaquo/python/target/3.8.20-1
        cd chaquopy/maven/com/chaquo/python/target/3.8.20-1
        
        # ä¸‹è½½æ‰€æœ‰å¿…è¦çš„ç»„ä»¶
        wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.8.20-1/target-3.8.20-1-arm64-v8a.zip
        wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.8.20-1/target-3.8.20-1-armeabi-v7a.zip
        wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.8.20-1/target-3.8.20-1-stdlib.zip
        wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.8.20-1/target-3.8.20-1-stdlib-pyc.zip
        
        # ä½¿ç”¨å¼ºåˆ¶è¦†ç›–é€‰é¡¹è§£åŽ‹ï¼ˆè§£å†³æ–‡ä»¶å†²çªé—®é¢˜ï¼‰
        unzip -o target-3.8.20-1-arm64-v8a.zip
        unzip -o target-3.8.20-1-armeabi-v7a.zip
        unzip -o target-3.8.20-1-stdlib.zip
        unzip -o target-3.8.20-1-stdlib-pyc.zip
        
        echo "âœ… Python 3.8.20-1 ç›®æ ‡æ–‡ä»¶ä¸‹è½½å®Œæˆ"

    - name: ðŸ”§ è®¾ç½® Android SDK
      run: |
        mkdir -p android-sdk/cmdlineæžé€Ÿç‰ˆ/latest
        cd android-sdk/cmdline-tools/latest
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip commandlinetools-linux-9477386_latest.zip
        cd ../../..
        echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV

    - name: ðŸ“š å®‰è£… Python ä¾èµ–
      run: |
        cd chaquopy/server/pypi
        pip install -r requirements.txt

    - name: ðŸ“ åˆ›å»º curl-cffi é…æ–¹
      run: |
        cd chaquopy/server/pypi
        mkdir -p packages/curl-cffi
        
        cat > packages/curl-cffi/meta.yaml << 'EOF'
        package:
          name: curl-cffi
          version: 0.7.0

        source:
          path: ../../../../

        build:
          number: 0

        requirements:
          build:
            - python
            - pip
            - setuptools
            - wheel
            - cffi
            - pycparser
          host:
            - python
            - cffi
            - pycparser
        EOF
        
        echo "âœ… curl-cffi æž„å»ºé…æ–¹åˆ›å»ºå®Œæˆ"

    - name: ðŸ—ï¸ æž„å»º Android åŒ…
      run: |
        cd chaquopy/server/pypi
        for abi in arm64-v8a armeabi-v7a; do
          echo "æž„å»º $abi æž¶æž„..."
          ./build-wheel.py --python 3.8.20 --abi $abi packages/curl-cffi/ || echo "âš ï¸ $abi æž¶æž„æž„å»ºå¤±è´¥"
        done

    - name: ðŸ” æ£€æŸ¥æž„å»ºäº§ç‰©
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„åŒ…æ–‡ä»¶..."
        cd chaquopy/server/pypi
        
        if [ -d "dist" ]; then
          echo "ðŸ“¦ æ‰¾åˆ°æž„å»ºäº§ç‰©:"
          ls -la dist/
          echo ""
          echo "ðŸ” ç”Ÿæˆçš„ .whl æ–‡ä»¶:"
          find dist -name "*.whl" | while read file; do
            echo "ðŸŽ¯ $file"
            # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            if [ -f "$file" ]; then
              echo "   âœ… æ–‡ä»¶å­˜åœ¨ ($(du -h "$file" | cut -f1))"
            fi
          done
        else
          echo "âŒ æœªæ‰¾åˆ° dist ç›®å½•"
          exit 1
        fi

    - name: â¬†ï¸ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: curl-cffi-android-wheels
        path: chaquopy/server/pypi/dist/
        retention-days: 30

    - name: âœ… æž„å»ºå®ŒæˆæŠ¥å‘Š
      run: |
        echo "ðŸŽ‰ BUILD SUCCESS"
        echo "================"
        echo "é¡¹ç›®:    curl-cffi"
        echo "å¹³å°:    Android"
        echo "Python:  3.8.20"
        echo "æž¶æž„:    arm64-v8a, armeabi-v7a"
        echo "çŠ¶æ€:    âœ… æˆåŠŸ"
        echo "æ—¶é—´:    $(date)"
        echo ""
        
        # æ˜¾ç¤ºç”Ÿæˆçš„äº§ç‰©
        if [ -d "chaquopy/server/pypi/dist" ]; then
          echo "ç”Ÿæˆçš„åŒ…æ–‡ä»¶:"
          cd chaquopy/server/pypi/dist
          for file in *.whl; do
            if [ -f "$file" ]; then
              echo "ðŸ“¦ $file"
            fi
          done
        fi
        
        echo ""
        echo "ä¸‹ä¸€æ­¥:"
        echo "1. ä¸‹è½½ 'curl-cffi-android-wheels' Artifact"
        echo "2. å°† .whl æ–‡ä»¶æ·»åŠ åˆ° Android é¡¹ç›®çš„ libs/ ç›®å½•"
        echo "3. åœ¨ build.gradle ä¸­é…ç½®æœ¬åœ°ä¾èµ–"
