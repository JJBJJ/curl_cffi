name: Build curl-cffi for Android

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: 
      - '**.py'
      - 'setup.py'
      - 'requirements.txt'

jobs:
  build-android:
    name: Build Android wheels
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ› ï¸ æ£€å‡º curl-cffi æºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ“¥ å…‹éš† Chaquopy æž„å»ºå·¥å…·
      run: |
        git clone --depth 1 https://github.com/chaquo/chaquopy.git

    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y patch patchelf pkg-config libssl-dev autoconf automake libtool

    - name: ðŸ”§ é…ç½® Android æž„å»ºçŽ¯å¢ƒ
      run: |
        mkdir -p android-sdk/cmdline-tools/latest
        cd android-sdk/cmdline-tools/latest
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        cd ../../..
        echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV

    - name: ðŸ“ å‡†å¤‡ Chaquopy æž„å»ºçŽ¯å¢ƒ
      run: |
        cd chaquopy/server/pypi
        pip install -r requirements.txt

    - name: ðŸ§ª åˆ›å»º curl-cffi æž„å»ºé…æ–¹
      run: |
        cd chaquopy/server/pypi
        mkdir -p packages/curl-cffi
        
        cat > packages/curl-cffi/meta.yaml << 'EOF'
        package:
          name: curl-cffi
          version: 0.7.0

        source:
          path: ../../../../

        build:
          number: 0

        requirements:
          build:
            - python
            - pip
            - setuptools
            - wheel
            - cffi
            - pycparser
          host:
            - python
            - cffi
            - pycparser
        EOF

    - name: ðŸ—ï¸ æž„å»º Android ABI åŒ…
      run: |
        cd chaquopy/server/pypi
        for abi in arm64-v8a armeabi-v7a; do
          ./build-wheel.py --python 3.8 --abi $abi packages/curl-cffi/ || echo "âš ï¸ $abi æž¶æž„æž„å»ºå¤±è´¥"
        done

    - name: â¬†ï¸ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: curl-cffi-android-wheels
        path: chaquopy/server/pypi/dist/
        retention-days: 30
