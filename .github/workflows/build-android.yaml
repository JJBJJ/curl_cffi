name: Build curl-cffi for Android

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths: 
      - '**.py'
      - 'setup.py'
      - 'requirements.txt'

jobs:
  build-android:
    name: Build Android wheels
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ› ï¸ æ£€å‡º curl-cffi æºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ“¥ å…‹éš† Chaquopy æž„å»ºå·¥å…·
      run: |
        echo "æ­£åœ¨å…‹éš† Chaquopy æž„å»ºå·¥å…·..."
        git clone --depth 1 https://github.com/chaquo/chaquopy.git
        echo "âœ… Chaquopy å·¥å…·å…‹éš†å®Œæˆ"

    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "å®‰è£…ç³»ç»Ÿæž„å»ºå·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y patch patchelf pkg-config libssl-dev autoconf automake libtool
        echo "âœ… ç³»ç»Ÿå·¥å…·å®‰è£…å®Œæˆ"

    - name: ðŸ”§ é…ç½® Android æž„å»ºçŽ¯å¢ƒ
      run: |
        echo "è®¾ç½® Android SDK..."
        mkdir -p android-sdk/cmdline-tools/latest
        cd android-sdk/cmdline-tools/latest
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        cd ../../..
        echo "ANDROID_HOME=$PWD/android-sdk" >> $GITHUB_ENV
        echo "âœ… Android SDK é…ç½®å®Œæˆ"

    - name: ðŸ“ å‡†å¤‡ Chaquopy æž„å»ºçŽ¯å¢ƒ
      run: |
        echo "å‡†å¤‡æž„å»ºçŽ¯å¢ƒ..."
        cd chaquopy/server/pypi
        
        # å®‰è£… Python ä¾èµ–
        pip install -r requirements.txt
        
        echo "âœ… æž„å»ºçŽ¯å¢ƒå‡†å¤‡å®Œæˆ"

    - name: ðŸ§ª åˆ›å»º curl-cffi æž„å»ºé…æ–¹
      run: |
        echo "åˆ›å»º curl-cffi Android æž„å»ºé…æ–¹..."
        cd chaquopy/server/pypi
        
        # åˆ›å»ºé…æ–¹ç›®å½•
        mkdir -p packages/curl-cffi
        
        # åˆ›å»º meta.yaml é…ç½®æ–‡ä»¶ï¼ˆå·²ç§»é™¤ script å­—æ®µï¼‰
        cat > packages/curl-cffi/meta.yaml << 'EOF'
        package:
          name: curl-cffi
          version: 0.7.0

        source:
          path: ../../../../  # æŒ‡å‘ curl-cffi æºç æ ¹ç›®å½•

        build:
          number: 0

        requirements:
          build:
            - python
            - pip
            - setuptools
            - wheel
            - cffi
            - pycparser
          host:
            - python
            - cffi
            - pycparser
          run:
            - python
            - cffi

        test:
          imports:
            - curl_cffi
        EOF
        
        echo "âœ… curl-cffi æž„å»ºé…æ–¹åˆ›å»ºå®Œæˆï¼ˆå·²ä¿®å¤ schema éªŒè¯é—®é¢˜ï¼‰"

    - name: ðŸ—ï¸ æž„å»º Android ABI åŒ…
      run: |
        echo "å¼€å§‹æž„å»º Android æž¶æž„åŒ…..."
        cd chaquopy/server/pypi
        
        # æž„å»ºä¸»è¦ Android ABI æž¶æž„
        for abi in arm64-v8a armeabi-v7a; do
          echo "ðŸ—ï¸ æž„å»º $abi æž¶æž„..."
          if ./build-wheel.py --python 3.8 --abi $abi packages/curl-cffi/; then
            echo "âœ… $abi æž¶æž„æž„å»ºæˆåŠŸ"
          else
            echo "âŒ $abi æž¶æž„æž„å»ºå¤±è´¥"
            # ç»§ç»­å°è¯•å…¶ä»–æž¶æž„
          fi
        done
        
        echo "ðŸ“¦ Android æž„å»ºè¿‡ç¨‹å®Œæˆ"

    - name: ðŸ” æŸ¥æ‰¾æž„å»ºäº§ç‰©
      run: |
        echo "æœç´¢æž„å»ºäº§ç‰©..."
        cd chaquopy/server/pypi
        
        # æ£€æŸ¥é¢„æœŸç›®å½•
        if [ -d "dist" ]; then
          echo "ðŸ“ åœ¨é¢„æœŸç›®å½•æ‰¾åˆ° dist/"
          ls -la dist/
        else
          echo "ðŸ” åœ¨å…¶å®ƒä½ç½®æœç´¢..."
          find . -name "*.whl" -type f | while read file; do
            echo "ðŸŽ¯ æ‰¾åˆ°: $file"
            # å¤åˆ¶åˆ°ç»Ÿä¸€ç›®å½•
            mkdir -p dist/
            cp "$file" dist/
          done
        fi
        
        # æœ€ç»ˆæ£€æŸ¥
        if [ -d "dist" ] && [ "$(ls -1 dist/ | wc -l)" -gt 0 ]; then
          echo "âœ… æ‰¾åˆ°æž„å»ºäº§ç‰©:"
          ls -la dist/
        else
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æž„å»ºäº§ç‰©"
          exit 1
        fi

    - name: ðŸ“Š éªŒè¯äº§ç‰©å®Œæ•´æ€§
      run: |
        echo "éªŒè¯æž„å»ºäº§ç‰©å®Œæ•´æ€§..."
        cd chaquopy/server/pypi
        
        if [ -d "dist" ]; then
          echo "ðŸ“‹ äº§ç‰©æ¸…å•:"
          find dist -name "*.whl" | while read file; do
            echo "ðŸ” æ£€æŸ¥: $file"
            # åŸºç¡€éªŒè¯
            if [[ $file == *"arm"* ]] || [[ $file == *"android"* ]]; then
              echo "   âœ… åŒ…å« Android æž¶æž„æ ‡è¯†"
            fi
            if [[ $file == *"cp38"* ]]; then
              echo "   âœ… Python 3.8 ç‰ˆæœ¬åŒ¹é…"
            fi
            if [ -f "$file" ]; then
              echo "   âœ… æ–‡ä»¶å­˜åœ¨ä¸”å¯è®¿é—®"
              ls -la "$file"
            else
              echo "   âŒ æ–‡ä»¶ä¸å­˜åœ¨"
            fi
          done
        fi

    - name: â¬†ï¸ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: curl-cffi-android-wheels
        path: |
          chaquopy/server/pypi/dist/
          dist/
        retention-days: 30

    - name: ðŸ“‹ ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      run: |
        echo "ðŸ“Š BUILD REPORT"
        echo "================"
        echo "Project:    curl-cffi"
        echo "Platform:   Android"
        echo "Python:     3.8"
        echo "Status:     âœ… SUCCESS"
        echo "Timestamp:  $(date)"
        echo ""
        
        # åˆ—å‡ºç”Ÿæˆçš„äº§ç‰©
        echo "Generated Artifacts:"
        if [ -d "chaquopy/server/pypi/dist" ]; then
          cd chaquopy/server/pypi/dist
          for file in *.whl; do
            if [ -f "$file" ]; then
              echo "ðŸ“¦ $file ($(du -h "$file" | cut -f1))"
            fi
          done
        fi
        
        echo ""
        echo "Next Steps:"
        echo "1. Download the artifact 'curl-cffi-android-wheels'"
        echo "2. Add .whl files to your Android project's libs/ directory"
        echo "3. Configure build.gradle to use the local wheels"
        echo ""
        echo "Example gradle configuration:"
        echo "python {"
        echo "    pip {"
        echo "        install files('libs/curl_cffi-0.7.0-cp38-cp38-android_arm64_v8a.whl')"
        echo "    }"
        echo "}"

  # å¯é€‰ï¼šæ·»åŠ æµ‹è¯•ä»»åŠ¡
  test-android:
    name: Test Android build
    runs-on: ubuntu-latest
    needs: build-android
    steps:
    - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: curl-cffi-android-wheels
        
    - name: ðŸ§ª åŸºæœ¬éªŒè¯
      run: |
        echo "éªŒè¯ä¸‹è½½çš„äº§ç‰©..."
        if [ -d "chaquopy/server/pypi/dist" ]; then
          echo "âœ… äº§ç‰©ä¸‹è½½æˆåŠŸ"
          ls -la chaquopy/server/pypi/dist/
        else
          echo "âš ï¸ äº§ç‰©ç›®å½•ç»“æž„å¯èƒ½ä¸åŒ"
          find . -name "*.whl" | head -5
        fi
