name: Build curl-cffi for Android

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ› ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¥ å…‹éš† Chaquopy
        run: |
          git clone --depth 1 https://github.com/chaquo/chaquopy.git
          echo "âœ… Chaquopy å…‹éš†å®Œæˆ"

      - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿå·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y patch patchelf wget unzip
          echo "âœ… ç³»ç»Ÿå·¥å…·å®‰è£…å®Œæˆ"

      - name: â¬‡ï¸ ä¸‹è½½ Python ç›®æ ‡æ–‡ä»¶
        run: |
          echo "ä¸‹è½½ Python 3.9.20-1 ç›®æ ‡æ–‡ä»¶..."
          mkdir -p chaquopy/maven/com/chaquo/python/target/3.9.20-1
          cd chaquopy/maven/com/chaquo/python/target/3.9.20-1

          wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.9.20-1/target-3.9.20-1-arm64-v8a.zip
          wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.9.20-1/target-3.9.20-1-armeabi-v7a.zip
          wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.9.20-1/target-3.9.20-1-stdlib.zip
          wget https://repo1.maven.org/maven2/com/chaquo/python/target/3.9.20-1/target-3.9.20-1-stdlib-pyc.zip

          unzip -o target-3.9.20-1-arm64-v8a.zip
          unzip -o target-3.9.20-1-armeabi-v7a.zip
          unzip -o target-3.9.20-1-stdlib.zip
          unzip -o target-3.9.20-1-stdlib-pyc.zip
          echo "âœ… Python ç›®æ ‡æ–‡ä»¶ä¸‹è½½å®Œæˆ"

      - name: ðŸ”§ è®¾ç½® Android SDK
        run: |
          echo "è®¾ç½® Android SDK..."
          mkdir -p android-sdk/cmdline-tools
          cd android-sdk/cmdline-tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip commandlinetools-linux-9477386_latest.zip -d latest/
          echo "ANDROID_HOME=$PWD/.." >> $GITHUB_ENV
          echo "âœ… Android SDK è®¾ç½®å®Œæˆ"

      - name: ðŸ“š å‡†å¤‡æž„å»ºçŽ¯å¢ƒ
        run: |
          cd chaquopy/server/pypi
          pip install -r requirements.txt
          echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ðŸ“ åˆ›å»º curl-cffi é…æ–¹
        run: |
          cd chaquopy/server/pypi
          mkdir -p packages/curl-cffi

          cat > packages/curl-cffi/meta.yaml <<'EOF'
          package:
            name: curl-cffi
            version: 0.13.0

          source:
            url: https://github.com/yifeikong/curl_cffi/archive/refs/tags/v0.13.0.tar.gz

          build:
            number: 0

          requirements:
            build: []
            host: []
          EOF
                echo "âœ… curl-cffi é…æ–¹å†™å…¥å®Œæˆ"

      - name: ðŸ—ï¸ æž„å»º Android åŒ…
        run: |
          cd chaquopy/server/pypi
          for abi in arm64-v8a armeabi-v7a; do
            echo "æž„å»º $abi æž¶æž„..."
            ./build-wheel.py --python 3.9 --abi "$abi" packages/curl-cffi/ || echo "âš ï¸ $abi æž¶æž„æž„å»ºå¤±è´¥"
          done

      - name: â¬†ï¸ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: curl-cffi-android-wheels
          path: chaquopy/server/pypi/dist/
